image: $CI_REGISTRY/knot/knot-resolver/ci/debian-stable:knot-2.6

variables:
  DEBIAN_FRONTEND: noninteractive
  LC_ALL: C.UTF-8
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_STRATEGY: clone # sometimes unclean submodule dirs otherwise
  COVERAGE: '1'
  PREFIX: $CI_PROJECT_DIR/.local
  LD_LIBRARY_PATH: $CI_PROJECT_DIR/.local/lib

stages:
  - build
  - test
  - coverage
  - respdiff
  - deploy

build:linux:amd64:
  stage: build
  script:
    - rm daemon/lua/kres-gen.lua
    - make -k all CFLAGS="-Werror -ggdb"
    - STATUS="$(git status --untracked-files=normal --porcelain)"
    - test -n "${STATUS}" && echo "${STATUS}" && echo "Build + install made working tree dirty, did you forget to update something?" && exit 2
    - make install CFLAGS="-Werror -ggdb"
  artifacts:
    untracked: true
  tags:
    - docker
    - linux
    - amd64


deckard:linux:amd64:
  stage: test
  variables:
    TMPDIR: $CI_PROJECT_DIR
  except:
    - schedules  # prevent unstable test from cancelling nightly OBS build
  script:
    - echo "${TMPDIR}"
    - DECKARDFLAGS="-n $(nproc)" PATH="$PREFIX/sbin:$PATH" make check-integration
    - echo "${CI_COMMIT_BEFORE_SHA}"
    - git diff-index --name-only origin/master | grep -E '^(AUTHORS|ci/|config.mk|COPYING|distro/|doc/|etc/|NEWS|README.md|scripts/|tests/|\.gitignore|\.gitlab-ci\.yml|\.travis.yml)'
  dependencies:
    - build:linux:amd64
  artifacts:
    when: always
    paths:
      - ./*.info
      - tmpdeckard*
    expire_in: 1 week
  tags:
    - docker
    - linux
    - amd64
