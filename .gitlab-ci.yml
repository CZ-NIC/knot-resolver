image: $CI_REGISTRY/knot/knot-resolver/ci/debian-stable:knot-2.7

variables:
  DEBIAN_FRONTEND: noninteractive
  LC_ALL: C.UTF-8
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_STRATEGY: clone # sometimes unclean submodule dirs otherwise
  PREFIX: $CI_PROJECT_DIR/.local
  LD_LIBRARY_PATH: $CI_PROJECT_DIR/.local/lib
  RESPDIFF_PRIORITY: 5
  RESPDIFF_COUNT: 1
  RESPDIFF_FORCE: 0
  RESPERF_FORCE: 0

stages:
  - build
  - test
  - coverage
  - extended
  - deploy

.build: &build
  variables:
    CFLAGS: -Werror -ggdb
  stage: build
  except:
    - master
  script:
    - rm daemon/lua/kres-gen.lua
    - make -k all
    - STATUS="$(git status --untracked-files=normal --porcelain)"
    - test -n "${STATUS}" && echo "${STATUS}" && echo "Build + install made working tree dirty, did you forget to update something?" && exit 2
    - make install
  artifacts:
    untracked: true
  tags:
    - docker
    - linux
    - amd64

build:linux:amd64:
  <<: *build

build:asan:linux:amd64:
  <<: *build
  variables:
    CFLAGS: -Werror -ggdb3 -O0 -fsanitize=address -fno-omit-frame-pointer

pytests:run:  &pytests
  stage: test
  dependencies:
    - build:asan:linux:amd64
  except:
    - master
  script:
    - pushd tests/pytests/rehandshake
    - make all
    - popd
    - PATH="$PREFIX/sbin:$PATH" ./ci/pytests/run.sh &> pytests.log.txt
  after_script:
    - tail -1 pytests.log.txt
    - echo "See pytests.html or pytests.log.txt for full report."
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - pytest*
  tags:
    - docker
    - linux
    - amd64

pytests:extended:
  stage: extended
  dependencies:
    - build:asan:linux:amd64
  except:
    - master
  script:
    - PATH="$PREFIX/sbin:$PATH" ./ci/pytests/run-extended.sh
  tags:
    - docker
    - linux
    - amd64


pytests:run1:  *pytests
pytests:run2:  *pytests
pytests:run3:  *pytests
pytests:run4:  *pytests
pytests:run5:  *pytests
pytests:run6:  *pytests
pytests:run7:  *pytests
pytests:run8:  *pytests
