# vim:foldmethod=marker
variables:
  DEBIAN_FRONTEND: noninteractive
  LC_ALL: C.UTF-8
  GIT_SUBMODULE_STRATEGY: recursive
  GIT_STRATEGY: clone # sometimes unclean submodule dirs otherwise
  RESPDIFF_PRIORITY: 5
  DISTROTEST_PRIORITY: 6
  RESPDIFF_COUNT: 1
  RESPDIFF_FORCE: 0
  RESPERF_FORCE: 0
  KNOT_VERSION: '2.8'
  LIBKRES_ABI: 9
  LIBKRES_NAME: libkres
  MESON_TEST: meson test -C build_ci* -t 2 --print-errorlogs
  PREFIX: $CI_PROJECT_DIR/.local

image: $CI_REGISTRY/knot/knot-resolver/ci/debian-buster:knot-$KNOT_VERSION

stages:
  - build

# build {{{
.build: &build
  stage: build
  artifacts:
    when: always
    paths:
      - .local
      - build_ci*
      - build_dist/meson-dist/*.tar.xz
  tags:
    - docker
    - linux
    - amd64

archive:
  <<: *build
  variables:
    GIT_COMMITER_NAME: 'ci'
    EMAIL: 'ci@nic'
  except:
    variables:
      - $TEST =~ '/^v\d+\.\d+\.\d+$/'
  script:
    - ./scripts/make-dev-archive.sh
