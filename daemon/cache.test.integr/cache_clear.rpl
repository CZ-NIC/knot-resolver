stub-addr: 2001:503:ba3e::2:30
trust-anchor: . IN DS 48409 8 2 3D63A0C25BCE86621DE63636F11B35B908EFE8E9381E0E3E9DEFD89EA952C27D
val-override-date: 20180601000000
query-minimization: off
harden-glue: off
CONFIG_END

SCENARIO_BEGIN test granular cache clear, see testroot.zone for data


RANGE_BEGIN 1 1000
        ADDRESS 2001:503:ba3e::2:30
        ADDRESS 198.41.0.4

ENTRY_BEGIN
MATCH opcode question
ADJUST copy_id
REPLY NOERROR QR AA DO
SECTION QUESTION
. IN DNSKEY
SECTION ANSWER
.					      1814400 IN DNSKEY	257 3 8 AwEAAcliJP8Jh/RjL3c8eaUj8dzVdEksENKubqVA5FdrDJ2rC0O/bGG/ MVZt+WacE1o1mRVwTT/TrhhZUAzZ+qOcpB+IWxURsR4vVqVwakHMny7D 2aLXKoVXwTo/VhAQtHDw5G9bxGgwybPUtd5Vz6EIenUsmNYZ+Spde4l8 vpw7UISVL6q0C1mwHMN18P/1yfHmbkS19b6B1S9Y2aputccF1lso3yiF Ig7UNqqD4PNxSo4jByDnajQSP3qg/LSJSOnzBIumb8wc6svxgugy/pxr BFKgGGk4/JdJCKufdfU5jFX4fJ3HM37G/RccrtGhIf2Z1utoOyaILoa9 wT3O1WaYG/U=
.					      1814400 IN RRSIG	DNSKEY 8 0 1814400 20180629135151 20180530135151 48409 . HRj68PBD0cR2p1njZcMUBecR5DiBbueyhIX1oqc9K9Rig5i+ONuozacm 3F4kg9DhUYb/1W6+PSp9YLyrJtCZOFLqkTjPiOAyiE6zVAE/U5O5LRZ/ FjqRQoWuA1cFZtrLokaWmW9GS5Kb2+PUCJY5NRz27JFSvaRRkoHIFf4o mA6eQsuWt28Itx0VGPL9+mR+2B+IcnmN+DZb7mxoRknOh0WyNop4eiep oSZcCihYHOdesCtmrxoMkwGEHZpu8a6GN7jaeNXXNUulwQYfzUZJZQo1 Zr9cN7kzIZ5tAs9ffnPRcWVO61MQTxUtuGbipFpba6RhGmML8oO4JkOJ Itp6tg==
ENTRY_END


ENTRY_BEGIN
MATCH opcode
ADJUST copy_id copy_query
REPLY SERVFAIL
SECTION QUESTION
ENTRY_END
RANGE_END

; sentinel does not affect qtypes different than A/AAAA
; +AD
STEP 111 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-is-ta-48409.test. IN TXT
ENTRY_END

STEP 112 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA AD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-is-ta-48409.test. IN TXT
SECTION ANSWER
root-key-sentinel-is-ta-48409.test. IN TXT "it works"
ENTRY_END

STEP 121 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN TXT
ENTRY_END

STEP 122 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA AD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN TXT
SECTION ANSWER
root-key-sentinel-not-ta-48409.test. IN TXT "it works"
ENTRY_END

; RD only
STEP 131 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
root-key-sentinel-is-ta-00000.test. IN TXT
ENTRY_END

STEP 132 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-is-ta-00000.test. IN TXT
SECTION ANSWER
root-key-sentinel-is-ta-00000.test. IN TXT "it works"
ENTRY_END

STEP 141 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN TXT
ENTRY_END

STEP 142 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN TXT
SECTION ANSWER
root-key-sentinel-not-ta-00000.test. IN TXT "it works"
ENTRY_END

; +CD
STEP 143 QUERY
ENTRY_BEGIN
REPLY RD CD
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN TXT
ENTRY_END

STEP 144 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA CD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN TXT
SECTION ANSWER
root-key-sentinel-not-ta-00000.test. IN TXT "it works"
ENTRY_END

; +CD+DO
STEP 145 QUERY
ENTRY_BEGIN
REPLY RD CD DO
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN TXT
ENTRY_END

STEP 146 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA CD DO NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN TXT
SECTION ANSWER
root-key-sentinel-not-ta-00000.test. IN TXT "it works"
root-key-sentinel-not-ta-00000.test. IN RRSIG TXT 8 2 1 20180629135151 20180530135151 48409 . SjAFtdUPy+YU4sZnst5GNNYxjzWhBOVq UAfGIUv3uBo5qZW9ePecUJ8GZkNUkdT7 m+cHd0c1ssOBOT7snjwc3Sy3zD22b6/q 3N8VowhDQDPkoDlBvt9raR7eXu273cEB DZTQ9P4Ya2Meu32Aftwa6VMQmXMl+qWX hYqffEt6bJuoohnCVqOZihqgnoT+sRiD l49RgLb+GnZNbFk5EP9LXOrWcdxczKso tY384WCrniRmg4L6NM5DjnBtUVT+Qs6f hWGqQv23fPiLV8lt4i34aIf2jAQkIE6K D4aNLlehct7eqFo1aeaiZumqEd9/GoqS at/RE7Qsh6hiRkfA/J7MLg==
ENTRY_END


; keyid 48409 is trusted
; is-ta hit for keyid 48409 -> NOERROR
; +AD
STEP 211 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-is-ta-48409.test. IN A
ENTRY_END

STEP 212 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA AD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-is-ta-48409.test. IN A
SECTION ANSWER
root-key-sentinel-is-ta-48409.test. 1 IN A 192.0.2.1
ENTRY_END

; RD only
STEP 221 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
root-key-sentinel-is-ta-48409.test. IN AAAA
ENTRY_END

STEP 222 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-is-ta-48409.test. IN AAAA
SECTION ANSWER
root-key-sentinel-is-ta-48409.test. 1 IN AAAA 2001:db8::
ENTRY_END


; not-ta miss for keyid 48409 -> SERVFAIL
; +AD
STEP 311 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN A
ENTRY_END

STEP 312 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA SERVFAIL
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN A
ENTRY_END

; query without AD must SERVFAIL as well
STEP 321 QUERY
ENTRY_BEGIN
REPLY RD
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN AAAA
ENTRY_END

STEP 322 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA SERVFAIL
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN AAAA
ENTRY_END

; +CD must disable sentinel logic
STEP 323 QUERY
ENTRY_BEGIN
REPLY RD CD
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN AAAA
ENTRY_END

STEP 324 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA CD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN AAAA
SECTION ANSWER
root-key-sentinel-not-ta-48409.test. IN AAAA 2001:db8::
ENTRY_END

; +CD+DO must disable sentinel logic as well
STEP 325 QUERY
ENTRY_BEGIN
REPLY RD CD DO
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN AAAA
ENTRY_END

STEP 326 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA CD DO NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-48409.test. IN AAAA
SECTION ANSWER
root-key-sentinel-not-ta-48409.test. IN AAAA 2001:db8::
root-key-sentinel-not-ta-48409.test. IN RRSIG AAAA 8 2 1 20180629135151 20180530135151 48409 . UYk1xmrw2A7ojKSTpwuF90WXsXOfNbRI 8pi9tDPLmqr0OMn29AW051vGTyLd7L3o gsaoUEDiY2vYyvyZI3kPL9fSRDYgOIk7 Cq3hp7k6wMM3IXS6iIlYnjtvUFGDaE69 EpUjwII22lSWaqOo0dCFnacJYWDfShdZ cv7yssWG9nZpki6aiBAjhYXY8tdMnpDJ zq9O3zXPQR8xtuFW4S0aVdrHuSPRq935 DWXThocHxOza6OQp/ZkbemkoqAYjTlu0 tyITwZsTknxgK1mtM+ArRmhSeykqVs3m mAGIWMN3qIW8SXKVRHI9PPjka0j6+KK+ bfmeck0bI2Wu1f3Ccnk+nQ==
ENTRY_END


; keyid 0x0000 is not trusted
; is-ta miss for keyid 0x0000 -> SERVFAIL
; +AD
STEP 411 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-is-ta-00000.test. IN A
ENTRY_END

STEP 412 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA SERVFAIL
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-is-ta-00000.test. IN A
ENTRY_END

STEP 422 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-is-ta-00000.test. IN AAAA
ENTRY_END

STEP 423 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA SERVFAIL
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-is-ta-00000.test. IN AAAA
ENTRY_END

; +CD must disable sentinel logic
STEP 424 QUERY
ENTRY_BEGIN
REPLY RD CD
SECTION QUESTION
root-key-sentinel-is-ta-00000.test. IN AAAA
ENTRY_END

STEP 425 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA CD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-is-ta-00000.test. IN AAAA
SECTION ANSWER
root-key-sentinel-is-ta-00000.test. IN AAAA 2001:db8::
ENTRY_END


; not-ta hit for keyid 0x0000 -> NOERROR
STEP 511 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN A
ENTRY_END

STEP 512 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA AD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN A
SECTION ANSWER
root-key-sentinel-not-ta-00000.test. IN A 192.0.2.1
ENTRY_END

STEP 521 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN AAAA
ENTRY_END

STEP 522 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA AD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-00000.test. IN AAAA
SECTION ANSWER
root-key-sentinel-not-ta-00000.test. IN AAAA 2001:db8::
ENTRY_END


; TA for non-root domains are interpreted correctly
; not-ta ignores existing non-root TA keyid 04759 -> NOERROR
STEP 611 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-not-ta-04759.test. IN A
ENTRY_END

STEP 612 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA AD NOERROR
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-not-ta-04759.test. IN A
SECTION ANSWER
root-key-sentinel-not-ta-04759.test. 1 IN A 192.0.2.33
ENTRY_END

; is-ta ignores existing non-root TA keyid 04759 -> SERVFAIL
STEP 621 QUERY
ENTRY_BEGIN
REPLY RD AD
SECTION QUESTION
root-key-sentinel-is-ta-04759.test. IN A
ENTRY_END

STEP 622 CHECK_ANSWER
ENTRY_BEGIN
REPLY QR RD RA SERVFAIL
MATCH opcode rcode flags question answer
SECTION QUESTION
root-key-sentinel-is-ta-04759.test. IN A
ENTRY_END

SCENARIO_END
