stages:
  - check

default:
  image: $CI_REGISTRY/knot/knot-resolver/ci/manager:knot-$KNOT_VERSION
  before_script:
    - cd manager
    - poetry --version
    - poetry env use $PYTHON_INTERPRETER
  tags:
    - docker
    - linux
    - amd64

lint:py3.11:
  stage: check
  script:
    - poetry install --only main,dev,lint
    - poe check
  variables:
    PYTHON_INTERPRETER: python3.11


.unit: &unit
  stage: check
  script:
    - poetry install --only main,dev,test
    # create required directories that are in default config, otherwise unit tests fail
    - mkdir -p /var/cache/knot-resolver
    - poe test
    # the following command makes sure that the source root of the coverage file is at $gitroot
    - poetry run bash -c "cd ..; coverage combine manager/.coverage; coverage xml"
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: manager/unit.junit.xml
    paths:
      - manager/unit.junit.xml

unit:py3.7:
  <<: *unit
  variables:
    PYTHON_INTERPRETER: python3.7

unit:py3.8:
  <<: *unit
  variables:
    PYTHON_INTERPRETER: python3.8

unit:py3.9:
  <<: *unit
  variables:
    PYTHON_INTERPRETER: python3.9

unit:py3.10:
  <<: *unit
  variables:
    PYTHON_INTERPRETER: python3.10

unit:py3.11:
  <<: *unit
  variables:
    PYTHON_INTERPRETER: python3.11