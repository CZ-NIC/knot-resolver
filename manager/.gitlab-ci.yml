stages:
  - image
  - check

default:
  image: registry.nic.cz/knot/knot-resolver-manager/knot-manager:ci
  before_script:
    # make sure Poetry is in $PATH
    - source $HOME/.poetry/env
    # there is already a pyproject.toml with installed dependencies in the root
    # it has its own virtualenv and we want to use that env in a different directory
    # so let's create a new one and replace it by the already existing one
    # we don't care about destroying the environment in process, because it's going to be discarded anyway
    - poetry env use $(which python3.6); ourpath=$(poetry env info -p); upperpath=$( (cd ..; poetry env info -p) ); rm -rf "$ourpath"; cp -a "$upperpath" "$ourpath"; mv /poetry.lock .
    # the virtualenv we recycled might have beed slightly out of date. Let's quickly update it
    - poetry install
    # fix podman; see https://gitlab.nic.cz/labs/lxc-gitlab-runner#nesting-with-podman
    - unset TMPDIR
  tags:
    - lxc
    - amd64

build:
  stage: image
  script:
    - poe container build --ci-login --push
  only:
    changes:
      - pyproject.toml
      - package.json
      - containers/**/*

lint:
  stage: check
  script:
    - poe check

test:
  stage: check
  script:
    - poe test
    - poetry run coverage xml
  artifacts:
    reports:
      cobertura: coverage.xml

integration:
  stage: check
  script:
    - poe container pull
    - poe integration -n
