{% if not cfg.lua.script_only %}

-- SERVER section
-- server.hostname
hostname('{{ cfg.server.hostname }}')

{% if cfg.server.nsid %}
-- server.nsid
modules.load('nsid')
nsid.name('{{ cfg.server.nsid }} ' .. worker.id)
{% endif %}

-- NETWORK section
-- network.interfaces
{% for item in cfg.network.interfaces %}
net.listen('{{ item.address }}', {{ item.port }}, {
    kind = '{{ item.kind if item.kind != 'dot' else 'tls' }}',
    freebind = {{ 'true' if item.freebind else 'false'}}
})
{% endfor %}

-- MODULES
modules = {
    {{ "'rebinding < iterate'," if cfg.options.rebinding_protection }}
    {{ "'workarounds < iterate'," if cfg.options.violators_workarounds }}
    {{ "'serve_stale < cache'," if cfg.options.serve_stale }}
    {{ "dns64 = '"+cfg.dns64.prefix+"'," if cfg.dns64 }}
}

-- OPTIONS section
mode('{{ cfg.options.glue_checking }}')
option('NO_MINIMIZE', {{ 'false' if cfg.options.qname_minimisation else 'true' }})
option('ALLOW_LOCAL', {{ 'true' if cfg.options.query_loopback else 'false' }})
option('REORDER_RR', {{ 'true' if cfg.options.reorder_rrset else 'false' }})
option('NO_0X20', {{ 'false' if cfg.options.query_case_randomization else 'true' }})
{{ "modules.unload('priming')" if not cfg.options.query_priming }}
{{ "modules.unload('detect_time_jump')" if not cfg.options.time_jump_detection }}
{{ "modules.unload('refuse_nord')" if not cfg.options.refuse_no_rd }}

-- DNSSEC section
{% if not cfg.dnssec %}
trust_anchors.remove('.')
{% endif %}

{{ "modules.unload('ta_sentinel')" if not cfg.dnssec.trust_anchor_sentinel }}
{{ "modules.unload('ta_signal_query')" if not cfg.dnssec.trust_anchor_signal_query }}
{{ "modules.unload('detect_time_skew')" if not cfg.dnssec.time_skew_detection }}

trust_anchors.keep_removed = {{ cfg.dnssec.keep_removed }}
{{ "trust_anchors.refresh_time = "+cfg.dnssec.refresh_time|string if cfg.dnssec.refresh_time }}

-- dnssec.trust-anchors
{% if cfg.dnssec.trust_anchors %}
{% for ta in cfg.dnssec.trust_anchors %}
trust_anchors.add('{{ ta }}')
{% endfor %}
{% endif %}

-- dnssec.negative-trust-anchors
{% if cfg.dnssec.negative_trust_anchors %}
trust_anchors.set_insecure({
{% for nta in cfg.dnssec.negative_trust_anchors %}
    '{{ nta }}',
{% endfor %}
})
{% endif %}

-- dnssec.trust-anchors-files
{% if cfg.dnssec.trust_anchors_files %}
{% for taf in cfg.dnssec.trust_anchors_files %}
trust_anchors.add_file('{{ taf.file }}',  readonly = {{ 'true' if taf.read_only else 'false' }})
{% endfor %}
{% endif %}

{% endif %}
-- LUA section
{% if cfg.lua.script_file %}
{% import cfg.lua.script_file as script_file %}
-- lua.script-file
{{ script_file }}
{% endif %}

{% if cfg.lua.script %}
-- lua.script
{{ cfg.lua.script }}
{% endif %}
