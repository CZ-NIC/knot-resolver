language: c
os:
    - osx
compiler:
    - clang
notifications:
    email:
        on_success: never
        on_failure: never
    slack:
        rooms: cznic:xNJmvHU2xu2aGtN7Y2eqHKoD
        on_success: never
        on_failure: never
matrix:
    fast_finish: true
env:
    global:
        - PKG_CONFIG_PATH="${HOME}/.local/lib/pkgconfig"
        - PATH="${HOME}/.local/bin:/usr/local/bin:${PATH}"
        - LD_LIBRARY_PATH="${HOME}/.local/lib"
        - DYLD_LIBRARY_PATH="${HOME}/.local/lib"
        - MALLOC_CHECK_=3
        - MALLOC_PERTURB_=223
before_script:
    - echo $CFLAGS
    - brew update
    - brew install makedepend cmocka gnutls luajit libuv
    - brew install knot  # FIXME build knot
    - BOOTSTRAP_CLEANUP=1 ./scripts/bootstrap-depends.sh ${HOME}/.local
    - rvm get stable || true
script:
    - CFLAGS="-O2 -g -fno-omit-frame-pointer -DDEBUG" make -j2 install check V=1 PREFIX=${HOME}/.local DYLD_LIBRARY_PATH=${DYLD_LIBRARY_PATH}
    - ./daemon/kresd -h
    - ./daemon/kresd -V
    - echo "quit()" | ./daemon/kresd -a 127.0.0.1@53535 .
    # Deckard should be OK just on Linux
    # - CFLAGS="-O2 -g -fno-omit-frame-pointer -DDEBUG" make -j2 check-integration PREFIX=${HOME}/.local DYLD_LIBRARY_PATH=${DYLD_LIBRARY_PATH}
after_success:
    - if test $TRAVIS_OS_NAME = linux; then coveralls -i lib -i daemon -x ".c" --gcov-options '\-lp'; fi
sudo: false
cache:
    directories:
    - ${HOME}/.local
    - ${HOME}/.cache/pip
before_cache:
    - rm -f ${HOME}/.local/sbin/kresd
    - rm -f ${HOME}/.local/lib/libkres.*
    - rm -rf ${HOME}/.local/include/libkres
    - rm -rf ${HOME}/.local/lib/kdns_modules
